<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BALL BATTLE</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Rajdhani:wght@400;600;700&display=swap');

  :root {
    --p1: #00e5ff;
    --p2: #ff4444;
    --bg: #0a0a0f;
    --panel: #111118;
    --border: #222233;
    --gold: #ffd700;
    --nuke-color: #ff6b00;
    --doge-color: #00ff88;
    --world-color: #cc44ff;
    --mih-color: #ffffff;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    font-family: 'Rajdhani', sans-serif;
    color: #fff;
    min-height: 100vh;
    overflow-x: hidden;
  }

  body::after {
    content: '';
    position: fixed;
    inset: 0;
    background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.03) 2px, rgba(0,0,0,0.03) 4px);
    pointer-events: none;
    z-index: 1000;
  }

  .page { display: none; min-height: 100vh; }
  .page.active { display: flex; flex-direction: column; align-items: center; justify-content: center; }

  /* ===== SELECT PAGE ===== */
  #page-select {
    padding: 20px;
    background: radial-gradient(ellipse at 50% 0%, #1a0033 0%, var(--bg) 60%);
  }

  .game-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: clamp(48px, 8vw, 96px);
    text-align: center;
    letter-spacing: 8px;
    background: linear-gradient(90deg, var(--p1), #fff, var(--p2));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 4px;
    animation: titlePulse 3s ease-in-out infinite;
  }

  @keyframes titlePulse {
    0%, 100% { filter: brightness(1); }
    50% { filter: brightness(1.3); }
  }

  .subtitle {
    text-align: center;
    font-size: 14px;
    letter-spacing: 4px;
    color: #555;
    margin-bottom: 40px;
    text-transform: uppercase;
  }

  .select-arena {
    display: flex;
    gap: 30px;
    align-items: flex-start;
    justify-content: center;
    flex-wrap: wrap;
    width: 100%;
    max-width: 960px;
  }

  .player-panel {
    flex: 1;
    min-width: 260px;
    max-width: 380px;
    border: 1px solid var(--border);
    border-radius: 12px;
    overflow: hidden;
    background: var(--panel);
    position: relative;
  }

  .player-panel::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 3px;
    border-radius: 2px 2px 0 0;
  }

  #panel-p1::before { background: var(--p1); box-shadow: 0 0 15px var(--p1); }
  #panel-p2::before { background: var(--p2); box-shadow: 0 0 15px var(--p2); }

  .panel-header {
    padding: 16px 20px;
    display: flex;
    align-items: center;
    gap: 10px;
    border-bottom: 1px solid var(--border);
  }

  .player-dot {
    width: 12px; height: 12px;
    border-radius: 50%;
    animation: blink 1.2s ease-in-out infinite;
  }

  #panel-p1 .player-dot { background: var(--p1); box-shadow: 0 0 8px var(--p1); }
  #panel-p2 .player-dot { background: var(--p2); box-shadow: 0 0 8px var(--p2); }

  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.3} }

  .panel-header span {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 22px;
    letter-spacing: 3px;
  }

  #panel-p1 .panel-header span { color: var(--p1); }
  #panel-p2 .panel-header span { color: var(--p2); }

  .chars {
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .char-card {
    border: 2px solid var(--border);
    border-radius: 10px;
    padding: 14px 16px;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
    overflow: hidden;
    background: rgba(255,255,255,0.02);
  }

  .char-card:hover { border-color: #444; transform: translateX(4px); }

  .char-card.selected-nuke  { border-color: var(--nuke-color);  background: rgba(255,107,0,0.1);   box-shadow: 0 0 20px rgba(255,107,0,0.2); }
  .char-card.selected-doge  { border-color: var(--doge-color);  background: rgba(0,255,136,0.1);   box-shadow: 0 0 20px rgba(0,255,136,0.2); }
  .char-card.selected-world { border-color: var(--world-color); background: rgba(204,68,255,0.1);  box-shadow: 0 0 20px rgba(204,68,255,0.2); }
  .char-card.selected-mih   { border-color: #fff; background: rgba(255,255,255,0.08); box-shadow: 0 0 20px rgba(255,255,255,0.3); }

  .char-top {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 8px;
  }

  .char-emoji {
    font-size: 36px;
    line-height: 1;
    animation: floatEmoji 2.5s ease-in-out infinite;
  }

  @keyframes floatEmoji {
    0%,100%{ transform: translateY(0); }
    50%{ transform: translateY(-5px); }
  }

  .char-info { flex: 1; }

  .char-name {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 24px;
    letter-spacing: 2px;
  }

  .char-card[data-char="nuke"]  .char-name { color: var(--nuke-color); }
  .char-card[data-char="doge"]  .char-name { color: var(--doge-color); }
  .char-card[data-char="world"] .char-name { color: var(--world-color); }

  .char-tag {
    font-size: 11px;
    letter-spacing: 2px;
    color: #666;
    text-transform: uppercase;
  }

  .char-desc {
    font-size: 13px;
    color: #888;
    line-height: 1.5;
  }

  .check {
    position: absolute;
    top: 10px; right: 10px;
    width: 22px; height: 22px;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 13px;
    opacity: 0;
    transition: opacity 0.2s;
  }

  .selected-nuke  .check { background: var(--nuke-color);  opacity: 1; }
  .selected-doge  .check { background: var(--doge-color);  opacity: 1; }
  .selected-world .check { background: var(--world-color); opacity: 1; }

  .vs-divider {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 60px;
    color: #333;
    text-shadow: 0 0 30px rgba(255,255,255,0.1);
    align-self: center;
    flex-shrink: 0;
  }

  .start-btn {
    margin-top: 30px;
    padding: 16px 60px;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 28px;
    letter-spacing: 5px;
    border: 2px solid #fff;
    background: transparent;
    color: #fff;
    cursor: pointer;
    border-radius: 6px;
    transition: all 0.2s;
  }

  .start-btn:disabled { border-color: #333; color: #444; cursor: not-allowed; }
  .start-btn:not(:disabled):hover { background: #fff; color: #000; box-shadow: 0 0 40px rgba(255,255,255,0.3); transform: scale(1.03); }

  .select-hint {
    margin-top: 10px;
    font-size: 12px;
    letter-spacing: 2px;
    color: #444;
    text-transform: uppercase;
  }

  /* ===== BATTLE PAGE ===== */
  #page-battle {
    flex-direction: column;
    padding: 20px;
    background: radial-gradient(ellipse at 50% 50%, #0d0d20 0%, var(--bg) 70%);
    gap: 0;
  }

  .hud {
    display: flex;
    width: 100%;
    max-width: 800px;
    align-items: center;
    gap: 10px;
    margin-bottom: 16px;
  }

  .hud-player {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .hud-name {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 18px;
    letter-spacing: 3px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  #hud-p1 .hud-name { color: var(--p1); }
  #hud-p2 .hud-name { color: var(--p2); justify-content: flex-end; }

  .hp-bar-wrap {
    height: 12px;
    background: #111;
    border-radius: 6px;
    border: 1px solid #222;
    overflow: hidden;
  }

  .hp-bar { height: 100%; border-radius: 6px; transition: width 0.3s; }
  #hp-bar-p1 { background: linear-gradient(90deg, #005577, var(--p1)); box-shadow: 0 0 10px var(--p1); }
  #hp-bar-p2 { background: linear-gradient(90deg, var(--p2), #770000); box-shadow: 0 0 10px var(--p2); margin-left: auto; }

  .hp-text { font-size: 13px; font-weight: 700; color: #aaa; }
  #hud-p2 .hp-text { text-align: right; }

  /* Skill cooldown label under HP */
  .skill-cd-label {
    font-size: 11px;
    letter-spacing: 1px;
    color: #555;
    text-transform: uppercase;
  }
  #hud-p2 .skill-cd-label { text-align: right; }

  .hud-vs {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 24px;
    color: #333;
    flex-shrink: 0;
    padding: 0 10px;
  }

  /* ARENA */
  .arena-wrap {
    width: 100%;
    max-width: 800px;
    position: relative;
  }

  #arena {
    width: 100%;
    height: 380px;
    background: #0a0a12;
    border: 1px solid #1e1e33;
    border-radius: 12px;
    position: relative;
    overflow: hidden;
  }

  #arena::before {
    content: '';
    position: absolute;
    inset: 0;
    background: radial-gradient(ellipse at 50% 80%, rgba(255,255,255,0.02) 0%, transparent 70%);
    pointer-events: none;
  }

  .ground {
    position: absolute;
    bottom: 0; left: 0; right: 0;
    height: 50px;
    background: linear-gradient(180deg, #111122, #0d0d1a);
    border-top: 2px solid #1e1e3a;
  }

  .ground-grid {
    position: absolute;
    inset: 0;
    background-image: linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px);
    background-size: 40px 100%;
  }

  /* BALLS */
  .ball {
    position: absolute;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 28px;
    user-select: none;
    z-index: 10;
    transition: box-shadow 0.2s;
  }

  #ball-p1 {
    width: 60px; height: 60px;
    background: radial-gradient(circle at 35% 35%, #66ffff, var(--p1), #003344);
    box-shadow: 0 0 20px rgba(0,229,255,0.5), 0 4px 10px rgba(0,0,0,0.5);
  }

  #ball-p2 {
    width: 60px; height: 60px;
    background: radial-gradient(circle at 35% 35%, #ffaaaa, var(--p2), #440000);
    box-shadow: 0 0 20px rgba(255,68,68,0.5), 0 4px 10px rgba(0,0,0,0.5);
  }

  .ball.mih-active {
    animation: mihGlow 0.4s ease-in-out infinite alternate;
  }

  @keyframes mihGlow {
    0%{ box-shadow: 0 0 15px #fff, 0 0 30px #aaf, 0 0 60px #88f; }
    100%{ box-shadow: 0 0 30px #fff, 0 0 60px #ccf, 0 0 100px #aaf; }
  }

  .ball.hit { animation: hitAnim 0.3s ease; }

  @keyframes hitAnim {
    0%,100%{ transform: scale(1); }
    50%{ transform: scale(0.85); filter: brightness(3); }
  }

  .ball.stunned {
    animation: stunAnim 0.5s ease-in-out infinite;
    filter: brightness(0.5) sepia(1) hue-rotate(200deg);
  }

  @keyframes stunAnim {
    0%,100%{ transform: rotate(-8deg) scale(0.95); }
    50%{ transform: rotate(8deg) scale(1.05); }
  }

  /* STUN STARS */
  .stun-stars {
    position: absolute;
    pointer-events: none;
    z-index: 25;
    font-size: 20px;
    animation: starsFloat 0.6s ease-in-out infinite alternate;
  }

  @keyframes starsFloat {
    0%{ transform: translateY(0) rotate(-10deg); }
    100%{ transform: translateY(-8px) rotate(10deg); }
  }

  /* NUKE EXPLOSION */
  .explosion {
    position: absolute;
    border-radius: 50%;
    background: radial-gradient(circle, #fff 0%, #ff6b00 30%, #ff0000 60%, transparent 100%);
    animation: explodeAnim 0.6s ease-out forwards;
    pointer-events: none;
    z-index: 20;
  }

  @keyframes explodeAnim {
    0%{ width: 0; height: 0; opacity: 1; transform: translate(-50%, -50%); }
    60%{ opacity: 0.8; }
    100%{ width: 250px; height: 250px; opacity: 0; transform: translate(-50%, -50%); }
  }

  /* THE WORLD EFFECT */
  .world-freeze {
    position: absolute;
    inset: 0;
    background: radial-gradient(ellipse at center, rgba(204,68,255,0.15) 0%, rgba(100,0,200,0.05) 60%, transparent 100%);
    animation: worldPulse 0.8s ease-in-out infinite;
    pointer-events: none;
    z-index: 15;
    border-radius: 12px;
  }

  @keyframes worldPulse {
    0%,100%{ opacity: 0.6; }
    50%{ opacity: 1; }
  }

  .world-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%,-50%);
    font-family: 'Bebas Neue', sans-serif;
    font-size: 52px;
    letter-spacing: 6px;
    color: var(--world-color);
    text-shadow: 0 0 40px var(--world-color), 0 0 80px rgba(204,68,255,0.5);
    animation: worldTextAnim 0.4s ease-out;
    pointer-events: none;
    z-index: 16;
    white-space: nowrap;
  }

  @keyframes worldTextAnim {
    0%{ transform: translate(-50%,-50%) scale(0.3); opacity: 0; }
    60%{ transform: translate(-50%,-50%) scale(1.1); opacity: 1; }
    100%{ transform: translate(-50%,-50%) scale(1); opacity: 1; }
  }

  /* DAMAGE POPUP */
  .dmg-popup {
    position: absolute;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 28px;
    animation: popupAnim 0.8s ease-out forwards;
    pointer-events: none;
    z-index: 30;
    text-shadow: 0 2px 8px rgba(0,0,0,0.8);
    transform: translateX(-50%);
  }

  @keyframes popupAnim {
    0%{ transform: translateX(-50%) translateY(0); opacity: 1; }
    100%{ transform: translateX(-50%) translateY(-60px); opacity: 0; }
  }

  .dmg-miss {
    position: absolute;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 24px;
    color: var(--doge-color);
    animation: popupAnim 0.8s ease-out forwards;
    pointer-events: none;
    z-index: 30;
    text-shadow: 0 0 15px var(--doge-color);
    transform: translateX(-50%);
  }

  /* NUKE TIMER */
  .nuke-timer {
    position: absolute;
    top: 10px;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 13px;
    letter-spacing: 2px;
    padding: 4px 12px;
    border-radius: 20px;
    background: rgba(255,107,0,0.15);
    border: 1px solid var(--nuke-color);
    color: var(--nuke-color);
    animation: timerBlink 1s ease-in-out infinite;
    z-index: 20;
  }

  @keyframes timerBlink { 0%,100%{opacity:1} 50%{opacity:0.5} }

  /* LOG */
  .battle-log {
    width: 100%;
    max-width: 800px;
    margin-top: 10px;
    height: 68px;
    overflow: hidden;
  }

  .log-inner {
    display: flex;
    flex-direction: column-reverse;
    gap: 4px;
    height: 100%;
    overflow: hidden;
  }

  .log-entry {
    font-size: 13px;
    color: #666;
    letter-spacing: 1px;
    animation: logFade 0.3s ease;
  }

  @keyframes logFade { from{opacity:0;transform:translateY(5px)} to{opacity:1;transform:none} }

  .log-entry.p1 { color: var(--p1); }
  .log-entry.p2 { color: var(--p2); }
  .log-entry.special { color: var(--gold); }
  .log-entry.world { color: var(--world-color); }

  /* SKILL COOLDOWN BARS */
  .skill-bars {
    width: 100%;
    max-width: 800px;
    display: flex;
    justify-content: space-between;
    margin-top: 10px;
    gap: 16px;
  }

  .skill-bar-group {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .skill-bar-group.right { align-items: flex-end; }

  .skill-bar-label {
    font-size: 11px;
    letter-spacing: 2px;
    color: #555;
    text-transform: uppercase;
  }

  .cooldown-bar {
    height: 5px;
    border-radius: 3px;
    width: 100%;
    background: #1a1a2e;
    overflow: hidden;
  }

  .cooldown-fill {
    height: 100%;
    border-radius: 3px;
    transition: width 0.1s linear;
    width: 0%;
  }

  #cd-p1 { background: var(--p1); }
  #cd-p2 { background: var(--p2); }

  /* WIN MODAL */
  .win-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.85);
    z-index: 500;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(6px);
  }

  .win-overlay.show { display: flex; }

  .win-box {
    text-align: center;
    padding: 50px 60px;
    border-radius: 16px;
    border: 1px solid #333;
    background: var(--panel);
    position: relative;
    overflow: hidden;
    animation: winPop 0.4s cubic-bezier(0.34,1.56,0.64,1);
  }

  @keyframes winPop {
    from{ transform: scale(0.5); opacity: 0; }
    to{ transform: scale(1); opacity: 1; }
  }

  .win-label {
    font-size: 13px;
    letter-spacing: 4px;
    color: #555;
    text-transform: uppercase;
    margin-bottom: 10px;
  }

  .win-char {
    font-size: 50px;
    margin-bottom: 20px;
    animation: floatEmoji 1.5s ease-in-out infinite;
  }

  .win-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 72px;
    letter-spacing: 6px;
    line-height: 1;
    margin-bottom: 16px;
  }

  .win-msg {
    font-size: 16px;
    color: #888;
    letter-spacing: 2px;
    margin-bottom: 30px;
  }

  .replay-btn {
    padding: 14px 50px;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 22px;
    letter-spacing: 4px;
    background: transparent;
    border: 2px solid #fff;
    color: #fff;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .replay-btn:hover { background: #fff; color: #000; box-shadow: 0 0 30px rgba(255,255,255,0.3); }

  /* CONFETTI */
  .confetti-piece {
    position: fixed;
    width: 8px; height: 8px;
    border-radius: 2px;
    animation: confettiFall linear forwards;
    z-index: 600;
  }

  @keyframes confettiFall {
    0%{ transform: translateY(-20px) rotate(0deg); opacity: 1; }
    100%{ transform: translateY(100vh) rotate(720deg); opacity: 0; }
  }

  /* COUNTER CLASH */
  .ball.counter-clash {
    animation: counterClashAnim 0.15s ease-in-out infinite;
  }
  @keyframes counterClashAnim {
    0%{ filter: brightness(3) hue-rotate(0deg); transform: scale(1.15); }
    100%{ filter: brightness(4) hue-rotate(180deg); transform: scale(0.9); }
  }
  .counter-text {
    position: absolute;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 44px;
    letter-spacing: 5px;
    color: #ff0;
    text-shadow: 0 0 30px #ff0, 0 0 60px #f80;
    animation: counterTextAnim 0.5s ease-out forwards;
    pointer-events: none;
    z-index: 35;
    white-space: nowrap;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
  }
  @keyframes counterTextAnim {
    0%{ opacity:0; transform: translate(-50%,-50%) scale(0.3); }
    40%{ opacity:1; transform: translate(-50%,-60%) scale(1.2); }
    100%{ opacity:0; transform: translate(-50%,-80%) scale(1); }
  }

  /* COUNTER CHAR */
  .char-card[data-char="counter"] .char-name { color: #ffdd00; }
  .char-card.selected-counter { border-color: #ffdd00; background: rgba(255,220,0,0.08); box-shadow: 0 0 20px rgba(255,220,0,0.3); }
  .selected-counter .check { background: #ffdd00; opacity: 1; }

  /* TANK CHAR */
  .char-card[data-char="tank"] .char-name { color: #aaffaa; }
  .char-card.selected-tank { border-color: #aaffaa; background: rgba(100,255,100,0.08); box-shadow: 0 0 20px rgba(100,255,100,0.3); }
  .selected-tank .check { background: #aaffaa; opacity: 1; color: #000; }


  /* POHON (SECRET) CHAR */
  .char-card[data-char="pohon"] .char-name { color: #00ff44; text-shadow: 0 0 10px #00ff44; }
  .char-card.selected-pohon { border-color: #00ff44; background: rgba(0,255,68,0.08); box-shadow: 0 0 20px rgba(0,255,68,0.4); }
  .selected-pohon .check { background: #00ff44; opacity: 1; color: #000; }


  /* SECRET CODE BOX */
  .secret-box {
    margin-top: 24px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
  }

  .secret-label {
    font-size: 11px;
    letter-spacing: 3px;
    color: #333;
    text-transform: uppercase;
  }

  .secret-inputs {
    display: flex;
    gap: 8px;
  }

  .secret-digit {
    width: 44px;
    height: 52px;
    background: #0d0d18;
    border: 1px solid #222;
    border-radius: 8px;
    text-align: center;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 28px;
    color: #fff;
    outline: none;
    caret-color: transparent;
    text-transform: uppercase;
    transition: border-color 0.2s, box-shadow 0.2s;
  }

  .secret-digit:focus {
    border-color: #444;
    box-shadow: 0 0 10px rgba(255,255,255,0.05);
  }

  .secret-digit.correct {
    border-color: #00ff44;
    box-shadow: 0 0 12px rgba(0,255,68,0.4);
    color: #00ff44;
  }

  .secret-digit.wrong {
    border-color: #ff4444;
    animation: shakeDigit 0.3s ease;
  }

  @keyframes shakeDigit {
    0%,100%{ transform: translateX(0); }
    25%{ transform: translateX(-4px); }
    75%{ transform: translateX(4px); }
  }

  /* SECRET UNLOCK NOTIF */
  .secret-unlock {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-family: 'Bebas Neue', sans-serif;
    font-size: 48px;
    letter-spacing: 6px;
    color: #00ff44;
    text-shadow: 0 0 40px #00ff44, 0 0 80px #00cc33;
    background: rgba(0,0,0,0.85);
    border: 2px solid #00ff44;
    border-radius: 16px;
    padding: 20px 40px;
    z-index: 9999;
    animation: secretPopIn 0.5s ease-out;
    text-align: center;
  }
  .secret-unlock small {
    display: block;
    font-size: 16px;
    letter-spacing: 3px;
    color: #aaffaa;
    margin-top: 4px;
  }
  @keyframes secretPopIn {
    0%{ transform: translate(-50%,-50%) scale(0.3); opacity: 0; }
    70%{ transform: translate(-50%,-50%) scale(1.1); opacity: 1; }
    100%{ transform: translate(-50%,-50%) scale(1); opacity: 1; }
  }

  /* POHON TREE hazard */
  .pohon-tree {
    position: absolute;
    font-size: 32px;
    z-index: 18;
    pointer-events: none;
    text-shadow: 0 0 20px #00ff44, 0 0 40px #00aa22;
    transform: translate(-50%, -50%);
    transition: none;
  }
  @keyframes treeHit {
    0%{ transform: translate(-50%,-50%) scale(1); opacity: 1; }
    100%{ transform: translate(-50%,-50%) scale(2.5); opacity: 0; }
  }

  /* √∑2 CHAR */
  --div2-color: #ff44cc;
  
  .char-card[data-char="div2"] .char-name { color: #ff44cc; text-shadow: 0 0 8px #ff44cc; }
  .char-card.selected-div2 { border-color: #ff44cc; background: rgba(255,68,204,0.08); box-shadow: 0 0 20px rgba(255,68,204,0.3); }
  .selected-div2 .check { background: #ff44cc; opacity: 1; }

  @keyframes div2Split {
    0%  { transform: translate(-50%,-50%) scale(0.5) rotate(-10deg); opacity: 0; }
    50% { transform: translate(-50%,-70%) scale(1.3) rotate(5deg);  opacity: 1; }
    100%{ transform: translate(-50%,-90%) scale(1)   rotate(0deg);  opacity: 0; }
  }
  .div2-popup {
    position: absolute;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 32px;
    color: #ff44cc;
    text-shadow: 0 0 20px #ff44cc, 0 0 40px #ff44cc;
    animation: div2Split 1s ease-out forwards;
    pointer-events: none;
    z-index: 31;
    white-space: nowrap;
    transform: translateX(-50%);
  }

  /* UNDEATH CHAR */
  .char-card[data-char="undeath"] .char-name { color: #aa44ff; text-shadow: 0 0 8px #aa44ff; }
  .char-card.selected-undeath { border-color: #aa44ff; background: rgba(170,68,255,0.08); box-shadow: 0 0 20px rgba(170,68,255,0.3); }
  .selected-undeath .check { background: #aa44ff; opacity: 1; }

  @keyframes undeathRevive {
    0%  { transform: translate(-50%,-50%) scale(0.3); opacity: 0; }
    50% { transform: translate(-50%,-80%) scale(1.4); opacity: 1; }
    100%{ transform: translate(-50%,-110%) scale(1); opacity: 0; }
  }
  .undeath-revive-text {
    position: absolute;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 36px;
    color: #aa44ff;
    text-shadow: 0 0 20px #aa44ff, 0 0 50px #7700cc;
    animation: undeathRevive 1.4s ease-out forwards;
    pointer-events: none;
    z-index: 31;
    white-space: nowrap;
    transform: translateX(-50%);
  }
  .ball.undeath-reviving {
    animation: undeathGlow 0.6s ease-in-out 3;
  }
  @keyframes undeathGlow {
    0%  { filter: brightness(0.1) hue-rotate(270deg); transform: scale(0.7); }
    50% { filter: brightness(3)   hue-rotate(270deg); transform: scale(1.3); }
    100%{ filter: brightness(1);  transform: scale(1); }
  }

  /* JHON CHAR */
  .char-card[data-char="jhon"] .char-name { color: #fffbe6; text-shadow: 0 0 10px #fff9a0, 0 0 20px #ffe066; }
  .char-card.selected-jhon { border-color: #ffe066; background: rgba(255,224,102,0.08); box-shadow: 0 0 20px rgba(255,224,102,0.35); }
  .selected-jhon .check { background: #ffe066; opacity: 1; color: #000; }

  .jhon-flash {
    position: absolute;
    inset: 0;
    background: radial-gradient(ellipse at center, rgba(255,255,200,0.98) 0%, rgba(255,255,100,0.7) 40%, transparent 75%);
    animation: jhonFlashAnim 0.5s ease-out forwards;
    pointer-events: none;
    z-index: 40;
    border-radius: 12px;
  }
  @keyframes jhonFlashAnim {
    0%  { opacity: 0; }
    15% { opacity: 1; }
    100%{ opacity: 0; }
  }
  .jhon-slow-ring {
    position: absolute;
    border-radius: 50%;
    border: 3px solid #ffe066;
    box-shadow: 0 0 12px #ffe066;
    pointer-events: none;
    z-index: 12;
    animation: jhonSlowPulse 0.8s ease-in-out infinite;
  }
  @keyframes jhonSlowPulse {
    0%,100%{ opacity: 0.5; transform: translate(-50%,-50%) scale(1); }
    50%    { opacity: 1;   transform: translate(-50%,-50%) scale(1.12); }
  }

  /* COLLISION FLASH */
  .collision-flash {
    position: absolute;
    border-radius: 50%;
    background: radial-gradient(circle, rgba(255,255,255,0.9) 0%, rgba(255,200,0,0.6) 40%, transparent 70%);
    animation: collisionFlashAnim 0.4s ease-out forwards;
    pointer-events: none;
    z-index: 22;
  }

  @keyframes collisionFlashAnim {
    0%{ width: 0; height: 0; opacity: 1; transform: translate(-50%,-50%); }
    100%{ width: 80px; height: 80px; opacity: 0; transform: translate(-50%,-50%); }
  }
</style>
</head>
<body>

<!-- ============ PAGE 1: SELECT ============ -->
<div class="page active" id="page-select">
  <div class="game-title">BALL BATTLE</div>
  <div class="subtitle">Bola Mantul ¬∑ Skill Otomatis ¬∑ 1v1</div>

  <div class="select-arena">
    <!-- P1 -->
    <div class="player-panel" id="panel-p1">
      <div class="panel-header">
        <div class="player-dot"></div>
        <span>Player 1</span>
      </div>
      <div class="chars" id="chars-p1">
        <div class="char-card" data-char="nuke" data-player="1">
          <div class="check">‚úì</div>
          <div class="char-top">
            <div class="char-emoji">üí£</div>
            <div class="char-info">
              <div class="char-name">NUKE</div>
              <div class="char-tag">Explosive ¬∑ High Risk</div>
            </div>
          </div>
          <div class="char-desc">Setelah <strong>15 detik</strong>, meledak otomatis: kasih damage ke lawan tapi <strong>dia sendiri juga mati!</strong></div>
        </div>
        <div class="char-card" data-char="doge" data-player="1">
          <div class="check">‚úì</div>
          <div class="char-top">
            <div class="char-emoji">üêï</div>
            <div class="char-info">
              <div class="char-name">DOGE</div>
              <div class="char-tag">Agile ¬∑ Evasive</div>
            </div>
          </div>
          <div class="char-desc">Setiap <strong>10 detik</strong>, otomatis aktif dodge ‚Äî hindari 1 tumbukan berikutnya!</div>
        </div>
        <div class="char-card" data-char="world" data-player="1">
          <div class="check">‚úì</div>
          <div class="char-top">
            <div class="char-emoji">üåç</div>
            <div class="char-info">
              <div class="char-name">THE WORLD</div>
              <div class="char-tag">Time Stop ¬∑ Stun</div>
            </div>
          </div>
          <div class="char-desc">Setiap <strong>14 detik</strong>, otomatis <strong>ZA WARUDO!</strong> ‚Äî stun lawan selama 3 detik. Bola lawan berhenti total!</div>
        </div>
        <div class="char-card" data-char="mih" data-player="1">
          <div class="check">‚úì</div>
          <div class="char-top">
            <div class="char-emoji">‚ö°</div>
            <div class="char-info">
              <div class="char-name">MADE IN HEAVEN</div>
              <div class="char-tag">Speed Up ¬∑ Damage Reduce</div>
            </div>
          </div>
          <div class="char-desc">Setiap <strong>12 detik</strong>, kecepatan otomatis nambah terus! Punya <strong>15% damage reduce</strong> tapi setiap tumbukan ngurangin <strong>12 HP lawan</strong>.</div>
        </div>
        <div class="char-card" data-char="counter" data-player="1">
          <div class="check">‚úì</div>
          <div class="char-top">
            <div class="char-emoji">üõ°Ô∏è</div>
            <div class="char-info">
              <div class="char-name">COUNTER</div>
              <div class="char-tag">Reactive ¬∑ Skill Cancel</div>
            </div>
          </div>
          <div class="char-desc">Pas lawan pakai skill, <strong>otomatis counter!</strong> Kedua bola saling tabrak ‚Äî skill lawan langsung dibatalin. No cooldown!</div>
        </div>
        <div class="char-card" data-char="tank" data-player="1">
          <div class="check">‚úì</div>
          <div class="char-top">
            <div class="char-emoji">ü™®</div>
            <div class="char-info">
              <div class="char-name">TANK</div>
              <div class="char-tag">Tanky ¬∑ 1000 HP ¬∑ Armored</div>
            </div>
          </div>
          <div class="char-desc">Punya <strong>1000 HP</strong> tapi hanya terima <strong>1‚Äì2 damage</strong> dari tumbukan. Lambat tapi susah dibunuh!</div>
        </div>
        <div class="char-card" data-char="div2" data-player="1">
          <div class="check">‚úì</div>
          <div class="char-top">
            <div class="char-emoji">‚ûó</div>
            <div class="char-info">
              <div class="char-name">√∑2</div>
              <div class="char-tag">Passive ¬∑ HP Divider</div>
            </div>
          </div>
          <div class="char-desc"><strong>[PASIF]</strong> Saat HP lawan bisa dibagi 2, damage = <strong>HP lawan √∑ 2</strong>! (cth: 100√∑2=50). Kalau HP ganjil, damage kembali normal.</div>
        </div>
        <div class="char-card" data-char="undeath" data-player="1">
          <div class="check">‚úì</div>
          <div class="char-top">
            <div class="char-emoji">üíÄ</div>
            <div class="char-info">
              <div class="char-name">UNDEATH</div>
              <div class="char-tag">Revive ¬∑ Second Life</div>
            </div>
          </div>
          <div class="char-desc">Saat mati, bangkit sekali! <strong>60%</strong>: isi 10% HP ¬∑ <strong>30%</strong>: isi 20% HP ¬∑ <strong>10%</strong>: isi 100% HP. Satu kali seumur hidup!</div>
        </div>
        <div class="char-card secret-char" data-char="jhon" data-player="1" id="jhon-card-p1" style="display:none">
          <div class="check">&#10003;</div>
          <div class="char-top">
            <div class="char-emoji">&#128161;</div>
            <div class="char-info">
              <div class="char-name">JHON</div>
              <div class="char-tag">Secret &#183; Blind &#183; Slow</div>
            </div>
          </div>
          <div class="char-desc">Setiap <strong>10 detik</strong>, tembak <strong>cahaya terang</strong> ke lawan &#8212; stun <strong>2 detik</strong> lalu slow <strong>5%</strong> selama <strong>4 detik</strong>!</div>
        </div>
        <div class="char-card secret-char" data-char="pohon" data-player="1" id="pohon-card-p1" style="display:none">
          <div class="check">‚úì</div>
          <div class="char-top">
            <div class="char-emoji" style="animation:none">üå¥</div>
            <div class="char-info">
              <div class="char-name">POHON</div>
              <div class="char-tag">Secret ¬∑ Hazard ¬∑ Stun Immune</div>
            </div>
          </div>
          <div class="char-desc">Lempar <strong>üå¥ pohon</strong> tiap 5 detik ‚Äî pohon bertahan <strong>3 detik</strong> dan kasih <strong>5 damage</strong> ke siapapun yang kena. <strong>Immune stun ZA WARUDO!</strong></div>
        </div>
      </div>
    </div>

    <div class="vs-divider">VS</div>

    <!-- P2 -->
    <div class="player-panel" id="panel-p2">
      <div class="panel-header">
        <div class="player-dot"></div>
        <span>Player 2</span>
      </div>
      <div class="chars" id="chars-p2">
        <div class="char-card" data-char="nuke" data-player="2">
          <div class="check">‚úì</div>
          <div class="char-top">
            <div class="char-emoji">üí£</div>
            <div class="char-info">
              <div class="char-name">NUKE</div>
              <div class="char-tag">Explosive ¬∑ High Risk</div>
            </div>
          </div>
          <div class="char-desc">Setelah <strong>15 detik</strong>, meledak otomatis: kasih damage ke lawan tapi <strong>dia sendiri juga mati!</strong></div>
        </div>
        <div class="char-card" data-char="doge" data-player="2">
          <div class="check">‚úì</div>
          <div class="char-top">
            <div class="char-emoji">üêï</div>
            <div class="char-info">
              <div class="char-name">DOGE</div>
              <div class="char-tag">Agile ¬∑ Evasive</div>
            </div>
          </div>
          <div class="char-desc">Setiap <strong>10 detik</strong>, otomatis aktif dodge ‚Äî hindari 1 tumbukan berikutnya!</div>
        </div>
        <div class="char-card" data-char="world" data-player="2">
          <div class="check">‚úì</div>
          <div class="char-top">
            <div class="char-emoji">üåç</div>
            <div class="char-info">
              <div class="char-name">THE WORLD</div>
              <div class="char-tag">Time Stop ¬∑ Stun</div>
            </div>
          </div>
          <div class="char-desc">Setiap <strong>14 detik</strong>, otomatis <strong>ZA WARUDO!</strong> ‚Äî stun lawan selama 3 detik. Bola lawan berhenti total!</div>
        </div>
        <div class="char-card" data-char="mih" data-player="2">
          <div class="check">‚úì</div>
          <div class="char-top">
            <div class="char-emoji">‚ö°</div>
            <div class="char-info">
              <div class="char-name">MADE IN HEAVEN</div>
              <div class="char-tag">Speed Up ¬∑ Damage Reduce</div>
            </div>
          </div>
          <div class="char-desc">Setiap <strong>12 detik</strong>, kecepatan otomatis nambah terus! Punya <strong>15% damage reduce</strong> tapi setiap tumbukan ngurangin <strong>12 HP lawan</strong>.</div>
        </div>
        <div class="char-card" data-char="counter" data-player="2">
          <div class="check">‚úì</div>
          <div class="char-top">
            <div class="char-emoji">üõ°Ô∏è</div>
            <div class="char-info">
              <div class="char-name">COUNTER</div>
              <div class="char-tag">Reactive ¬∑ Skill Cancel</div>
            </div>
          </div>
          <div class="char-desc">Pas lawan pakai skill, <strong>otomatis counter!</strong> Kedua bola saling tabrak ‚Äî skill lawan langsung dibatalin. No cooldown!</div>
        </div>
        <div class="char-card" data-char="tank" data-player="2">
          <div class="check">‚úì</div>
          <div class="char-top">
            <div class="char-emoji">ü™®</div>
            <div class="char-info">
              <div class="char-name">TANK</div>
              <div class="char-tag">Tanky ¬∑ 1000 HP ¬∑ Armored</div>
            </div>
          </div>
          <div class="char-desc">Punya <strong>1000 HP</strong> tapi hanya terima <strong>1‚Äì2 damage</strong> dari tumbukan. Lambat tapi susah dibunuh!</div>
        </div>
        <div class="char-card" data-char="div2" data-player="2">
          <div class="check">‚úì</div>
          <div class="char-top">
            <div class="char-emoji">‚ûó</div>
            <div class="char-info">
              <div class="char-name">√∑2</div>
              <div class="char-tag">Passive ¬∑ HP Divider</div>
            </div>
          </div>
          <div class="char-desc"><strong>[PASIF]</strong> Saat HP lawan bisa dibagi 2, damage = <strong>HP lawan √∑ 2</strong>! (cth: 100√∑2=50). Kalau HP ganjil, damage kembali normal.</div>
        </div>
        <div class="char-card" data-char="undeath" data-player="2">
          <div class="check">‚úì</div>
          <div class="char-top">
            <div class="char-emoji">üíÄ</div>
            <div class="char-info">
              <div class="char-name">UNDEATH</div>
              <div class="char-tag">Revive ¬∑ Second Life</div>
            </div>
          </div>
          <div class="char-desc">Saat mati, bangkit sekali! <strong>60%</strong>: isi 10% HP ¬∑ <strong>30%</strong>: isi 20% HP ¬∑ <strong>10%</strong>: isi 100% HP. Satu kali seumur hidup!</div>
        </div>
        <div class="char-card secret-char" data-char="jhon" data-player="2" id="jhon-card-p2" style="display:none">
          <div class="check">&#10003;</div>
          <div class="char-top">
            <div class="char-emoji">&#128161;</div>
            <div class="char-info">
              <div class="char-name">JHON</div>
              <div class="char-tag">Secret &#183; Blind &#183; Slow</div>
            </div>
          </div>
          <div class="char-desc">Setiap <strong>10 detik</strong>, tembak <strong>cahaya terang</strong> ke lawan &#8212; stun <strong>2 detik</strong> lalu slow <strong>5%</strong> selama <strong>4 detik</strong>!</div>
        </div>
        <div class="char-card secret-char" data-char="pohon" data-player="2" id="pohon-card-p2" style="display:none">
          <div class="check">‚úì</div>
          <div class="char-top">
            <div class="char-emoji" style="animation:none">üå¥</div>
            <div class="char-info">
              <div class="char-name">POHON</div>
              <div class="char-tag">Secret ¬∑ Hazard ¬∑ Stun Immune</div>
            </div>
          </div>
          <div class="char-desc">Lempar <strong>üå¥ pohon</strong> tiap 5 detik ‚Äî pohon bertahan <strong>3 detik</strong> dan kasih <strong>5 damage</strong> ke siapapun yang kena. <strong>Immune stun ZA WARUDO!</strong></div>
        </div>
      </div>
    </div>
  </div>

  <button class="start-btn" id="start-btn" disabled>MULAI BATTLE</button>
  <div class="select-hint" id="select-hint">Pilih karakter untuk kedua player</div>
  <div class="secret-box">
    <div class="secret-label">üîí Masukkan Kode Rahasia (5 digit)</div>
    <div class="secret-inputs" id="secret-inputs">
      <input class="secret-digit" maxlength="1" id="sd0" autocomplete="off" spellcheck="false">
      <input class="secret-digit" maxlength="1" id="sd1" autocomplete="off" spellcheck="false">
      <input class="secret-digit" maxlength="1" id="sd2" autocomplete="off" spellcheck="false">
      <input class="secret-digit" maxlength="1" id="sd3" autocomplete="off" spellcheck="false">
      <input class="secret-digit" maxlength="1" id="sd4" autocomplete="off" spellcheck="false">
    </div>
  </div>
</div>

<!-- ============ PAGE 2: BATTLE ============ -->
<div class="page" id="page-battle">
  <div class="hud">
    <div class="hud-player" id="hud-p1">
      <div class="hud-name">
        <span id="p1-icon">?</span>
        <span id="p1-hud-name">PLAYER 1</span>
      </div>
      <div class="hp-bar-wrap">
        <div class="hp-bar" id="hp-bar-p1" style="width:100%"></div>
      </div>
      <div class="hp-text" id="hp-text-p1">100 HP</div>
      <div class="skill-cd-label" id="skill-label-p1">Skill: ‚Äî</div>
    </div>
    <div class="hud-vs">VS</div>
    <div class="hud-player" id="hud-p2">
      <div class="hud-name" style="justify-content:flex-end">
        <span id="p2-hud-name">PLAYER 2</span>
        <span id="p2-icon">?</span>
      </div>
      <div class="hp-bar-wrap">
        <div class="hp-bar" id="hp-bar-p2" style="width:100%; margin-left:auto; direction:rtl"></div>
      </div>
      <div class="hp-text" id="hp-text-p2" style="text-align:right">100 HP</div>
      <div class="skill-cd-label" id="skill-label-p2" style="text-align:right">Skill: ‚Äî</div>
    </div>
  </div>

  <div class="arena-wrap">
    <div id="arena">
      <div class="ground"><div class="ground-grid"></div></div>
      <div class="ball" id="ball-p1">üí£</div>
      <div class="ball" id="ball-p2">üí£</div>
    </div>
  </div>

  <div class="skill-bars">
    <div class="skill-bar-group">
      <div class="skill-bar-label" id="cd-label-p1">Skill Cooldown P1</div>
      <div class="cooldown-bar"><div class="cooldown-fill" id="cd-p1"></div></div>
    </div>
    <div class="skill-bar-group right">
      <div class="skill-bar-label" id="cd-label-p2">Skill Cooldown P2</div>
      <div class="cooldown-bar"><div class="cooldown-fill" id="cd-p2"></div></div>
    </div>
  </div>

  <div class="battle-log">
    <div class="log-inner" id="log-inner"></div>
  </div>
</div>

<!-- WIN MODAL -->
<div class="win-overlay" id="win-overlay">
  <div class="win-box" id="win-box">
    <div class="win-label">üèÜ PEMENANG üèÜ</div>
    <div class="win-char" id="win-char">üí£</div>
    <div class="win-title" id="win-title">PLAYER 1</div>
    <div class="win-msg" id="win-msg">menang telak!</div>
    <button class="replay-btn" onclick="replay()">üîÑ MAIN LAGI</button>
  </div>
</div>

<script>
// =========== GAME STATE ===========
const BALL_SIZE = 60;
const COLLISION_DMG_MIN = 8;
const COLLISION_DMG_MAX = 18;
const COLLISION_COOLDOWN = 600; // ms between collision damage procs
const BALL_SPEED = 5;

const state = {
  chars: { 1: null, 2: null },
  hp: { 1: 100, 2: 100 },
  maxHp: { 1: 100, 2: 100 },
  gameOver: false,

  // Ball physics
  pos: { 1: { x: 80, y: 200 }, 2: { x: 660, y: 200 } },
  vel: { 1: { x: 0, y: 0 },    2: { x: 0, y: 0 } },
  arenaW: 800, arenaH: 380,
  groundY: 50,

  // Skills
  dodge: { 1: false, 2: false },
  stunned: { 1: false, 2: false },
  stunTimeout: { 1: null, 2: null },
  worldRestartTimeout: { 1: null, 2: null },
  dogeRestartTimeout: { 1: null, 2: null },
  mihRestartTimeout: { 1: null, 2: null },
  mihSpeed: { 1: 5, 2: 5 },
  counterClashing: false, // MiH current speed (matches BALL_SPEED=5)

  // Timers
  nukeInterval: { 1: null, 2: null },
  nukeTimer: { 1: 30, 2: 30 },
  dogeSkillInterval: { 1: null, 2: null },
  worldSkillInterval: { 1: null, 2: null },
  worldSkillTimer: { 1: 40, 2: 40 },
  dogeSkillTimer: { 1: 10, 2: 10 },

  skillCdInterval: { 1: null, 2: null },

  lastCollision: 0,
  rafId: null,
  pohonTrees: [],      // active tree hazards [{x,y,el,timeout}]
  pohonSkillInterval: { 1: null, 2: null },
  undeathRevived: { 1: false, 2: false },
  jhonSkillInterval: { 1: null, 2: null },
  jhonSlowed: { 1: false, 2: false },
  jhonSlowTimeout: { 1: null, 2: null },
};

const charData = {
  nuke:  { icon: 'üí£', name: 'NUKE',      skillName: 'BOMB CHARGE' },
  doge:  { icon: 'üêï', name: 'DOGE',      skillName: 'AUTO DODGE' },
  world: { icon: 'üåç', name: 'THE WORLD', skillName: 'ZA WARUDO' },
  mih:     { icon: '‚ö°', name: 'MADE IN HEAVEN', skillName: 'SPEED UP' },
  counter: { icon: 'üõ°Ô∏è', name: 'COUNTER', skillName: 'COUNTER' },
  tank:    { icon: 'ü™®', name: 'TANK',    skillName: 'ARMOR' },
  pohon:   { icon: 'üå¥', name: 'POHON',   skillName: 'LEMPAR POHON' },
  undeath: { icon: 'üíÄ', name: 'UNDEATH', skillName: 'REVIVE' },
  jhon:    { icon: 'üí°', name: 'JHON',    skillName: 'FLASH BLIND' },
  div2:    { icon: '‚ûó', name: '√∑2',      skillName: 'PASIF: HP HALVER' },
};

// =========== SELECT LOGIC ===========
document.querySelectorAll('.char-card').forEach(card => {
  card.addEventListener('click', () => {
    const player = card.dataset.player;
    const char = card.dataset.char;
    document.querySelectorAll(`#chars-p${player} .char-card`).forEach(c => {
      c.classList.remove('selected-nuke', 'selected-doge', 'selected-world', 'selected-mih', 'selected-counter', 'selected-tank', 'selected-pohon', 'selected-div2', 'selected-undeath', 'selected-jhon');
    });
    card.classList.add(`selected-${char}`);
    state.chars[player] = char;
    checkReady();
  });
});

function checkReady() {
  const btn = document.getElementById('start-btn');
  const hint = document.getElementById('select-hint');
  if (state.chars[1] && state.chars[2]) {
    btn.disabled = false;
    hint.textContent = `${charData[state.chars[1]].name} vs ${charData[state.chars[2]].name} ‚Äî SIAP!`;
    hint.style.color = '#888';
  } else {
    btn.disabled = true;
    const missing = !state.chars[1] ? 'Player 1' : 'Player 2';
    hint.textContent = `${missing} belum pilih karakter`;
  }
}

document.getElementById('start-btn').addEventListener('click', startBattle);

// =========== ARENA SIZE ===========
function getArenaSize() {
  const arena = document.getElementById('arena');
  return { w: arena.clientWidth, h: arena.clientHeight };
}

// =========== BATTLE INIT ===========
function startBattle() {
  const arena = document.getElementById('arena');
  const w = arena.clientWidth || 800;
  const h = arena.clientHeight || 380;

  // Set HP based on character
  [1, 2].forEach(p => {
    const opp = p === 1 ? 2 : 1;
    const isTank = state.chars[p] === 'tank';
    const isCounterVsTank = state.chars[p] === 'counter' && state.chars[opp] === 'tank';
    const isPohon = state.chars[p] === 'pohon';
    const hp = isTank ? 1000 : isPohon ? 100 : isCounterVsTank ? 500 : 100;
    state.hp[p] = hp;
    state.maxHp[p] = hp;
  });
  state.dodge = { 1: false, 2: false };
  state.stunned = { 1: false, 2: false };
  state.mihSpeed = { 1: 5, 2: 5 }; // reset to base BALL_SPEED
  state.counterClashing = false;
  state.gameOver = false;
  state.lastCollision = 0;

  // Initial positions (middle height)
  state.pos[1] = { x: 80,          y: 140 };
  state.pos[2] = { x: w - 80 - BALL_SIZE, y: 140 };

  // Initial velocities ‚Äî diagonal, constant speed
  const angle1 = Math.PI * 0.25 + Math.random() * 0.3;
  const angle2 = Math.PI * 0.75 - Math.random() * 0.3;
  state.vel[1] = { x: Math.cos(angle1) * BALL_SPEED, y: Math.sin(angle1) * BALL_SPEED };
  state.vel[2] = { x: Math.cos(angle2) * BALL_SPEED, y: Math.sin(angle2) * BALL_SPEED };

  document.getElementById('log-inner').innerHTML = '';

  [1, 2].forEach(p => {
    const ch = charData[state.chars[p]];
    document.getElementById(`p${p}-icon`).textContent = ch.icon;
    document.getElementById(`p${p}-hud-name`).textContent = `P${p} ¬∑ ${ch.name}`;
    const ballEl = document.getElementById(`ball-p${p}`);
    ballEl.textContent = ch.icon;
    ballEl.classList.remove('mih-active', 'stunned', 'hit');
    document.getElementById(`cd-p${p}`).style.width = '0%';
    updateHpBar(p);

    // Clear old timers
    clearTimeout(state.nukeInterval[p]);
    clearTimeout(state.dogeSkillInterval[p]);
    clearTimeout(state.worldSkillInterval[p]);
    clearTimeout(state.skillCdInterval[p]);
    if (state.stunTimeout[p]) clearTimeout(state.stunTimeout[p]);
    if (state.worldRestartTimeout[p]) clearTimeout(state.worldRestartTimeout[p]);
    if (state.dogeRestartTimeout[p]) clearTimeout(state.dogeRestartTimeout[p]);
    if (state.mihRestartTimeout[p]) clearTimeout(state.mihRestartTimeout[p]);
    if (state.pohonSkillInterval[p]) clearTimeout(state.pohonSkillInterval[p]);
    if (state.jhonSkillInterval[p]) clearTimeout(state.jhonSkillInterval[p]);
    if (state.jhonSlowTimeout[p]) clearTimeout(state.jhonSlowTimeout[p]);
    state.jhonSlowed[p] = false;
    const slowRing = document.getElementById('jhon-slow-ring-' + p); if (slowRing) slowRing.remove();

    const el = document.getElementById(`nuke-timer-${p}`);
    if (el) el.remove();
    document.getElementById(`ball-p${p}`)?.classList.remove('counter-clash', 'mih-active', 'stunned');
  });

  // Clear any leftover pohon trees
  state.pohonTrees.forEach(t => { if (t.el && t.el.parentNode) t.el.parentNode.removeChild(t.el); clearTimeout(t.timeout); });
  state.pohonTrees = [];

  // Remove world overlay if any
  const wf = document.getElementById('world-freeze');
  if (wf) wf.remove();
  const wt = document.getElementById('world-text');
  if (wt) wt.remove();

  showPage('battle');
  addLog('üîî BATTLE DIMULAI! Bola mulai mantul!', 'special');
  addLog('üí• Tumbukan antar bola = DAMAGE!', 'special');

  // Start skill timers
  [1, 2].forEach(p => {
    if (state.chars[p] === 'nuke')  startNukeTimer(p);
    if (state.chars[p] === 'doge')  startDogeSkillTimer(p);
    if (state.chars[p] === 'world') startWorldSkillTimer(p);
    if (state.chars[p] === 'mih')   startMihTimer(p);
    if (state.chars[p] === 'counter') {
      document.getElementById(`skill-label-p${p}`).textContent = 'üõ°Ô∏è Counter: SIAP';
      document.getElementById(`cd-p${p}`).style.width = '100%';
    }
    if (state.chars[p] === 'tank') {
      document.getElementById(`skill-label-p${p}`).textContent = 'ü™® ARMOR: AKTIF';
      document.getElementById(`cd-p${p}`).style.width = '100%';
    }
    if (state.chars[p] === 'pohon') startPohonTimer(p);
    if (state.chars[p] === 'undeath') {
      state.undeathRevived[p] = false;
      document.getElementById(`skill-label-p${p}`).textContent = 'üíÄ REVIVE: SIAP';
      document.getElementById(`cd-p${p}`).style.width = '100%';
    }
    if (state.chars[p] === 'jhon') {
      state.jhonSlowed[p] = false;
      startJhonTimer(p);
    }
    if (state.chars[p] === 'div2') {
      document.getElementById(`skill-label-p${p}`).textContent = '‚ûó PASIF: HP Halver AKTIF';
      document.getElementById(`cd-p${p}`).style.width = '100%';
    }
  });

  // Start physics loop
  if (state.rafId) cancelAnimationFrame(state.rafId);
  gameLoop();
}

// =========== PHYSICS LOOP ===========
// No gravity ‚Äî pure billiard bounce, constant speed

function gameLoop(ts = 0) {
  if (state.gameOver) return;

  const arena = document.getElementById('arena');
  const w = arena.clientWidth;
  const h = arena.clientHeight;

  [1, 2].forEach(p => {
    if (state.stunned[p]) return;

    // Move
    state.pos[p].x += state.vel[p].x;
    state.pos[p].y += state.vel[p].y;

    // --- Floor bounce (ground div is 50px tall) ---
    const floor = h - 50;
    if (state.pos[p].y + BALL_SIZE >= floor) {
      state.pos[p].y = floor - BALL_SIZE;
      state.vel[p].y = -Math.abs(state.vel[p].y);
    }

    // --- Ceiling bounce ---
    if (state.pos[p].y <= 0) {
      state.pos[p].y = 0;
      state.vel[p].y = Math.abs(state.vel[p].y);
    }

    // --- Left wall bounce ---
    if (state.pos[p].x <= 0) {
      state.pos[p].x = 0;
      state.vel[p].x = Math.abs(state.vel[p].x);
    }

    // --- Right wall bounce ---
    if (state.pos[p].x + BALL_SIZE >= w) {
      state.pos[p].x = w - BALL_SIZE;
      state.vel[p].x = -Math.abs(state.vel[p].x);
    }

    // Lock to per-player speed (MiH gets faster over time)
    const jhonMult = state.jhonSlowed[p] ? 0.95 : 1.0;
    const targetSpd = ((state.chars[p] === 'mih') ? state.mihSpeed[p] : BALL_SPEED) * jhonMult;
    const spd = Math.sqrt(state.vel[p].x**2 + state.vel[p].y**2);
    if (spd > 0.01) {
      state.vel[p].x = (state.vel[p].x / spd) * targetSpd;
      state.vel[p].y = (state.vel[p].y / spd) * targetSpd;
    }

    // Update DOM
    const ball = document.getElementById(`ball-p${p}`);
    ball.style.left = state.pos[p].x + 'px';
    ball.style.top  = state.pos[p].y + 'px';

    // Update stun stars position
    const stars = document.getElementById(`stun-stars-${p}`);
    if (stars) {
      stars.style.left = (state.pos[p].x + BALL_SIZE/2 - 15) + 'px';
      stars.style.top  = (state.pos[p].y - 28) + 'px';
    }
    // Update jhon slow ring position
    const slowRingEl = document.getElementById('jhon-slow-ring-' + p);
    if (slowRingEl) {
      slowRingEl.style.left = (state.pos[p].x + BALL_SIZE/2) + 'px';
      slowRingEl.style.top  = (state.pos[p].y + BALL_SIZE/2) + 'px';
    }
  });

  // Ball-ball collision
  checkBallCollision();

  // Pohon tree hazard check
  checkPohonTrees();

  state.rafId = requestAnimationFrame(gameLoop);
}

function checkBallCollision() {
  const x1 = state.pos[1].x + BALL_SIZE / 2;
  const y1 = state.pos[1].y + BALL_SIZE / 2;
  const x2 = state.pos[2].x + BALL_SIZE / 2;
  const y2 = state.pos[2].y + BALL_SIZE / 2;

  const dist = Math.sqrt((x2-x1)**2 + (y2-y1)**2);
  if (dist < BALL_SIZE) {
    const angle = Math.atan2(y2-y1, x2-x1);
    const overlap = BALL_SIZE - dist;

    // Only push non-stunned balls
    if (!state.stunned[1]) {
      state.pos[1].x -= Math.cos(angle) * overlap/2;
      state.pos[1].y -= Math.sin(angle) * overlap/2;
    }
    if (!state.stunned[2]) {
      state.pos[2].x += Math.cos(angle) * overlap/2;
      state.pos[2].y += Math.sin(angle) * overlap/2;
    }

    // Reflect: if target stunned, attacker fully bounces off (wall-like)
    const nx = (x2-x1)/dist;
    const ny = (y2-y1)/dist;

    if (state.stunned[1] && !state.stunned[2]) {
      // P1 stunned, P2 bounces off
      const dot2 = state.vel[2].x * nx + state.vel[2].y * ny;
      state.vel[2].x -= 2 * dot2 * nx;
      state.vel[2].y -= 2 * dot2 * ny;
      const spd2 = Math.sqrt(state.vel[2].x**2 + state.vel[2].y**2);
      if (spd2 > 0.01) { state.vel[2].x = (state.vel[2].x/spd2)*BALL_SPEED; state.vel[2].y = (state.vel[2].y/spd2)*BALL_SPEED; }
    } else if (state.stunned[2] && !state.stunned[1]) {
      // P2 stunned, P1 bounces off
      const dot1 = state.vel[1].x * (-nx) + state.vel[1].y * (-ny);
      state.vel[1].x -= 2 * dot1 * (-nx);
      state.vel[1].y -= 2 * dot1 * (-ny);
      const spd1 = Math.sqrt(state.vel[1].x**2 + state.vel[1].y**2);
      if (spd1 > 0.01) { state.vel[1].x = (state.vel[1].x/spd1)*BALL_SPEED; state.vel[1].y = (state.vel[1].y/spd1)*BALL_SPEED; }
    } else {
      // Normal elastic collision
      const dvx = state.vel[1].x - state.vel[2].x;
      const dvy = state.vel[1].y - state.vel[2].y;
      const dot = dvx*nx + dvy*ny;
      if (dot > 0) {
        state.vel[1].x -= dot * nx;
        state.vel[1].y -= dot * ny;
        state.vel[2].x += dot * nx;
        state.vel[2].y += dot * ny;
        [1,2].forEach(p => {
          const spd = Math.sqrt(state.vel[p].x**2 + state.vel[p].y**2);
          if (spd > 0.01) { state.vel[p].x = (state.vel[p].x/spd)*BALL_SPEED; state.vel[p].y = (state.vel[p].y/spd)*BALL_SPEED; }
        });
      }
    }



    // Deal collision damage (with cooldown)
    const now = Date.now();
    if (now - state.lastCollision > COLLISION_COOLDOWN) {
      state.lastCollision = now;
      onBallCollision(x1 + (x2-x1)/2, y1 + (y2-y1)/2);
    }
  }
}

function onBallCollision(cx, cy) {
  if (state.gameOver) return;

  // Flash at collision point
  const arena = document.getElementById('arena');
  const arenaRect = arena.getBoundingClientRect();
  const flash = document.createElement('div');
  flash.className = 'collision-flash';
  flash.style.left = cx + 'px';
  flash.style.top  = cy + 'px';
  arena.appendChild(flash);
  setTimeout(() => flash.remove(), 400);

  // Deal damage to both ‚Äî check dodge, stun x3
  [1, 2].forEach(target => {
    if (state.chars[target] === 'doge' && state.dodge[target] && !state.stunned[target]) {
      // Consume dodge
      state.dodge[target] = false;
      clearDodgeVisual(target);
      // Cancel the auto-expire timeout, restart cooldown now
      if (state.dogeRestartTimeout[target]) clearTimeout(state.dogeRestartTimeout[target]);
      startDogeSkillTimer(target);
      showMiss(target);
      addLog(`üêï Player ${target} DODGE tumbukan!`, `p${target}`);
      return;
    }
    const attacker = target === 1 ? 2 : 1;
    // MiH always deals 12 flat dmg when it collides
    let dmg = (state.chars[attacker] === 'mih')
      ? 12
      : Math.floor(Math.random() * (COLLISION_DMG_MAX - COLLISION_DMG_MIN + 1)) + COLLISION_DMG_MIN;

    // div2 PASSIVE: if target HP divisible by 2, damage = HP/2
    // Counter membatalkan pasif (damage tetap normal)
    if (state.chars[attacker] === 'div2' && state.chars[target] !== 'counter') {
      const oppHp = state.hp[target];
      if (oppHp % 2 === 0 && oppHp > 0) {
        dmg = Math.floor(oppHp / 2);
      }
    }
    // x3 damage if target is stunned
    if (state.stunned[target]) {
      dmg = dmg * 3;
      addLog(`üí• STUN BONUS! P${target} kena ${dmg} dmg (x3)! üåç`, 'world');
    } else if (state.chars[attacker] === 'mih') {
      addLog(`‚ö° MiH serang! P${target} kena ${dmg} dmg!`, `p${attacker}`);
    } else {
      addLog(`üí• Tumbukan! P${target} kena ${dmg} dmg!`, `p${target}`);
    }
    // TANK: hanya terima 1-2 damage dari tumbukan
    if (state.chars[target] === 'tank' && !state.stunned[target]) {
      // Counter vs Tank: x3 damage tembus armor!
      if (state.chars[attacker] === 'counter') {
        dmg = dmg * 3;
        addLog(`üõ°Ô∏è COUNTER hancurin armor! P${target} kena ${dmg} dmg (x3)!`, 'special');
      } else {
        dmg = Math.floor(Math.random() * 2) + 1;
        addLog(`ü™® TANK P${target} cuma kena ${dmg} dmg! (Armored)`, `p${target}`);
      }
    }
    dealDamage(target, dmg);
  });
}

// =========== COUNTER SYSTEM ===========
// Returns true if counter activated (skill should be cancelled)
function tryCounter(skillUser) {
  const opponent = skillUser === 1 ? 2 : 1;
  if (state.chars[opponent] !== 'counter') return false;
  if (state.gameOver) return false;
  if (state.counterClashing) return false;

  state.counterClashing = true;

  addLog('üõ°Ô∏è COUNTER! P' + opponent + ' batalin skill P' + skillUser + '!', 'special');

  // Show COUNTER! text
  const arena = document.getElementById('arena');
  const ct = document.createElement('div');
  ct.className = 'counter-text';
  ct.textContent = 'COUNTER!';
  arena.appendChild(ct);
  setTimeout(() => ct.remove(), 800);

  // Flash counter player ball only
  const cBall = document.getElementById('ball-p' + opponent);
  cBall.classList.add('counter-clash');
  setTimeout(() => cBall.classList.remove('counter-clash'), 400);

  // Deal damage to skill user
  const dmg = Math.floor(Math.random() * 15) + 12;
  setTimeout(() => {
    if (state.gameOver) return;
    addLog('üõ°Ô∏è Counter hit! P' + skillUser + ' kena ' + dmg + ' dmg!', 'special');
    dealDamage(skillUser, dmg);
    document.getElementById('skill-label-p' + opponent).textContent = 'üõ°Ô∏è Counter: SIAP';
    state.counterClashing = false;
  }, 200);

  return true; // skill cancelled
}

// =========== NUKE TIMER ===========
function startNukeTimer(p) {
  if (state.gameOver || state.chars[p] !== 'nuke') return;
  state.nukeTimer[p] = 15;
  showNukeTimerHUD(p);
  tickNuke(p);
}

function tickNuke(p) {
  if (state.gameOver || state.chars[p] !== 'nuke') return;
  if (state.stunned[p]) {
    // paused ‚Äî check again in 200ms
    state.nukeInterval[p] = setTimeout(() => tickNuke(p), 200);
    return;
  }
  if (state.nukeTimer[p] <= 0) {
    nukeExplode(p);
    return;
  }
  document.getElementById(`skill-label-p${p}`).textContent = `üí£ Meledak: ${state.nukeTimer[p]}s`;
  updateNukeTimerHUD(p);
  const pct = ((15 - state.nukeTimer[p]) / 15) * 100;
  document.getElementById(`cd-p${p}`).style.width = pct + '%';
  state.nukeTimer[p]--;
  state.nukeInterval[p] = setTimeout(() => tickNuke(p), 1000);
}

function showNukeTimerHUD(p) {
  const existing = document.getElementById(`nuke-timer-${p}`);
  if (existing) existing.remove();
  const el = document.createElement('div');
  el.className = 'nuke-timer';
  el.id = `nuke-timer-${p}`;
  el.style.left  = p === 1 ? '10px' : 'auto';
  el.style.right = p === 2 ? '10px' : 'auto';
  el.textContent = `üí£ P${p} MELEDAK: 15s`;
  document.getElementById('arena').appendChild(el);
}

function updateNukeTimerHUD(p) {
  const el = document.getElementById(`nuke-timer-${p}`);
  if (el) el.textContent = `üí£ P${p} MELEDAK: ${state.nukeTimer[p]}s`;
}

function nukeExplode(p) {
  if (state.gameOver) return;
  if (tryCounter(p)) {
    // Skill cancelled ‚Äî restart nuke timer
    addLog(`üí• LEDAKAN P${p} di-COUNTER! Nuke reset!`, 'special');
    startNukeTimer(p);
    return;
  }
  const el = document.getElementById(`nuke-timer-${p}`);
  if (el) el.remove();

  const target = p === 1 ? 2 : 1;
  const dmg = 55;

  addLog(`üí• PLAYER ${p} MELEDAK!`, 'special');
  doExplosion(p);

  setTimeout(() => {
    if (state.gameOver) return;
    // Lawan kena damage
    addLog(`Player ${target} kena ledakan ${dmg} damage!`, `p${target}`);
    dealDamage(target, dmg);
    // NUKE sendiri juga mati setelah ledakan
    setTimeout(() => {
      if (state.gameOver) return;
      addLog(`üíÄ Player ${p} mati terkena ledakannya sendiri!`, 'special');
      dealDamage(p, 9999); // instant death for bomb owner
    }, 200);
  }, 400);
}

function doExplosion(p) {
  const arena = document.getElementById('arena');
  const exp = document.createElement('div');
  exp.className = 'explosion';
  exp.style.left = (state.pos[p].x + BALL_SIZE/2) + 'px';
  exp.style.top  = (state.pos[p].y + BALL_SIZE/2) + 'px';
  arena.appendChild(exp);
  setTimeout(() => exp.remove(), 700);

  const ball = document.getElementById(`ball-p${p}`);
  ball.style.transform = 'scale(2)';
  setTimeout(() => ball.style.transform = '', 300);
}

// =========== DOGE SKILL TIMER ===========
function startDogeSkillTimer(p) {
  if (state.gameOver || state.chars[p] !== 'doge') return;
  state.dogeSkillTimer[p] = 10;
  tickDoge(p);
}

function tickDoge(p) {
  if (state.gameOver || state.chars[p] !== 'doge') return;
  if (state.stunned[p]) {
    // paused ‚Äî check again in 200ms
    state.dogeSkillInterval[p] = setTimeout(() => tickDoge(p), 200);
    return;
  }
  if (state.dogeSkillTimer[p] <= 0) {
    activateDodge(p);
    return;
  }
  const pct = ((10 - state.dogeSkillTimer[p]) / 10) * 100;
  document.getElementById(`cd-p${p}`).style.width = pct + '%';
  document.getElementById(`skill-label-p${p}`).textContent = `üêï Dodge: ${state.dogeSkillTimer[p]}s`;
  state.dogeSkillTimer[p]--;
  state.dogeSkillInterval[p] = setTimeout(() => tickDoge(p), 1000);
}

function activateDodge(p) {
  if (state.gameOver || state.chars[p] !== 'doge') return;
  if (tryCounter(p)) {
    // Dodge cancelled ‚Äî restart doge timer
    addLog(`üêï Dodge P${p} di-COUNTER! Dodge batal!`, 'special');
    startDogeSkillTimer(p);
    return;
  }
  state.dodge[p] = true;

  const ball = document.getElementById(`ball-p${p}`);
  ball.style.outline = '3px solid var(--doge-color)';
  ball.style.boxShadow = '0 0 30px var(--doge-color)';

  addLog(`üêï Player ${p} siap DODGE tumbukan berikutnya!`, `p${p}`);
  document.getElementById(`skill-label-p${p}`).textContent = `üêï DODGE AKTIF!`;
  document.getElementById(`cd-p${p}`).style.width = '100%';

  // After dodge is consumed or 5s max, restart cooldown
  state.dogeRestartTimeout[p] = setTimeout(() => {
    if (state.gameOver || state.chars[p] !== 'doge') return;
    state.dodge[p] = false;
    clearDodgeVisual(p);
    startDogeSkillTimer(p);
  }, 5000);
}

function clearDodgeVisual(p) {
  const ball = document.getElementById(`ball-p${p}`);
  ball.style.outline = '';
  ball.style.boxShadow = '';
}

// =========== THE WORLD SKILL TIMER ===========
function startWorldSkillTimer(p) {
  if (state.gameOver || state.chars[p] !== 'world') return;
  state.worldSkillTimer[p] = 14;
  tickWorld(p);
}

function tickWorld(p) {
  if (state.gameOver || state.chars[p] !== 'world') return;
  if (state.stunned[p]) {
    state.worldSkillInterval[p] = setTimeout(() => tickWorld(p), 200);
    return;
  }
  if (state.worldSkillTimer[p] <= 0) {
    activateWorldSkill(p);
    return;
  }
  const pct = ((14 - state.worldSkillTimer[p]) / 14) * 100;
  document.getElementById(`cd-p${p}`).style.width = pct + '%';
  document.getElementById(`skill-label-p${p}`).textContent = `üåç Za Warudo: ${state.worldSkillTimer[p]}s`;
  state.worldSkillTimer[p]--;
  state.worldSkillInterval[p] = setTimeout(() => tickWorld(p), 1000);
}

function activateWorldSkill(p) {
  if (state.gameOver) return;
  if (state.chars[p] !== 'world') return;
  if (tryCounter(p)) {
    addLog(`üåç ZA WARUDO P${p} di-COUNTER! Skill batal!`, 'special');
    startWorldSkillTimer(p);
    return;
  }
  const target = p === 1 ? 2 : 1;
  const stunDuration = 3000;

  addLog(`üåç ZA WARUDO! Player ${p} stop waktu! Player ${target} di-STUN!`, 'world');

  // Show dramatic effect
  const arena = document.getElementById('arena');

  const wf = document.createElement('div');
  wf.className = 'world-freeze';
  wf.id = 'world-freeze';
  arena.appendChild(wf);

  const wt = document.createElement('div');
  wt.className = 'world-text';
  wt.id = 'world-text';
  wt.textContent = 'ZA WARUDO!';
  arena.appendChild(wt);

  setTimeout(() => { wt.remove(); }, 1200);
  setTimeout(() => { wf.remove(); }, stunDuration);

  // Stun target ‚Äî POHON is immune!
  if (state.chars[target] === 'pohon') {
    addLog(`üå¥ POHON P${target} IMMUNE! ZA WARUDO ga mempan!`, 'special');
    state.worldRestartTimeout[p] = setTimeout(() => {
      if (!state.gameOver && state.chars[p] === 'world') startWorldSkillTimer(p);
    }, stunDuration + 100);
    return;
  }
  state.stunned[target] = true;

  // Pause all skill timers of the stunned player
  clearInterval(state.nukeInterval[target]);
  clearInterval(state.dogeSkillInterval[target]);
  clearInterval(state.worldSkillInterval[target]);

  // Show stun stars
  const stars = document.createElement('div');
  stars.className = 'stun-stars';
  stars.id = `stun-stars-${target}`;
  stars.textContent = '‚≠êüí´‚≠ê';
  arena.appendChild(stars);

  document.getElementById(`ball-p${target}`).classList.add('stunned');

  if (state.stunTimeout[target]) clearTimeout(state.stunTimeout[target]);
  state.stunTimeout[target] = setTimeout(() => {
    if (state.gameOver) return;
    state.stunned[target] = false;
    document.getElementById(`ball-p${target}`).classList.remove('stunned');
    const s = document.getElementById(`stun-stars-${target}`);
    if (s) s.remove();
    addLog(`Player ${target} bebas dari stun! Skill timer lanjut!`, `p${target}`);

    // Tick functions auto-resume since they check state.stunned[p]
    // Just need to kick off the tick again
    const ch = state.chars[target];
    if (ch === 'nuke') state.nukeInterval[target] = setTimeout(() => tickNuke(target), 200);
    else if (ch === 'doge') {
      if (state.dodge[target]) {
        // was in dodge-active window, let dogeRestartTimeout handle it
      } else {
        state.dogeSkillInterval[target] = setTimeout(() => tickDoge(target), 200);
      }
    }
    else if (ch === 'world') state.worldSkillInterval[target] = setTimeout(() => tickWorld(target), 200);
  }, stunDuration);

  document.getElementById(`skill-label-p${p}`).textContent = `üåç ZA WARUDO AKTIF!`;
  document.getElementById(`cd-p${p}`).style.width = '100%';

  // Restart cooldown after stun duration
  state.worldRestartTimeout[p] = setTimeout(() => {
    if (!state.gameOver && state.chars[p] === 'world') startWorldSkillTimer(p);
  }, stunDuration + 100);
}

// =========== RESUME TIMERS AFTER STUN ===========
// No longer needed ‚Äî tickX functions handle pausing automatically via stunned check

// (Resume functions removed ‚Äî tick functions handle auto-resume via stunned check)

// =========== MADE IN HEAVEN TIMER ===========
function startMihTimer(p) {
  if (state.gameOver || state.chars[p] !== 'mih') return;
  tickMih(p, 12);
}

function tickMih(p, remaining) {
  if (state.gameOver || state.chars[p] !== 'mih') return;
  if (state.stunned[p]) {
    state.mihRestartTimeout[p] = setTimeout(() => tickMih(p, remaining), 200);
    return;
  }
  if (remaining <= 0) {
    if (tryCounter(p)) {
      addLog(`‚ö° Speed Up P${p} di-COUNTER! Kecepatan batal nambah!`, 'special');
      state.mihRestartTimeout[p] = setTimeout(() => tickMih(p, 12), 500);
      return;
    }
    // Speed up!
    state.mihSpeed[p] = Math.min(state.mihSpeed[p] + 2.5, 28); // cap at 28
    const ball = document.getElementById(`ball-p${p}`);
    ball.classList.add('mih-active');
    addLog(`‚ö° MADE IN HEAVEN P${p}! Kecepatan ${state.mihSpeed[p].toFixed(1)}!`, 'special');
    document.getElementById(`skill-label-p${p}`).textContent = `‚ö° SPEED: ${state.mihSpeed[p].toFixed(1)}x`;
    document.getElementById(`cd-p${p}`).style.width = '100%';
    // Flash effect
    setTimeout(() => document.getElementById(`cd-p${p}`).style.width = '0%', 300);
    // Start next cycle
    state.mihRestartTimeout[p] = setTimeout(() => tickMih(p, 12), 500);
    return;
  }
  const pct = ((12 - remaining) / 12) * 100;
  document.getElementById(`cd-p${p}`).style.width = pct + '%';
  document.getElementById(`skill-label-p${p}`).textContent = `‚ö° Speed up: ${remaining}s`;
  state.mihRestartTimeout[p] = setTimeout(() => tickMih(p, remaining - 1), 1000);
}

// =========== DAMAGE ===========
function dealDamage(target, dmg) {
  if (state.gameOver) return;
  // MiH: 15% damage reduction
  if (state.chars[target] === 'mih') {
    dmg = Math.floor(dmg * 0.85);
  }

  state.hp[target] = Math.max(0, state.hp[target] - dmg);
  updateHpBar(target);
  showDamagePopup(target, dmg);

  const ball = document.getElementById(`ball-p${target}`);
  ball.classList.add('hit');
  setTimeout(() => ball.classList.remove('hit'), 400);

  if (state.hp[target] <= 0) {
    // UNDEATH: revive sekali
    if (state.chars[target] === 'undeath' && !state.undeathRevived[target]) {
      state.undeathRevived[target] = true;
      state.hp[target] = 0;
      updateHpBar(target);
      setTimeout(() => triggerUndeathRevive(target), 300);
      return;
    }
    endGame(target === 1 ? 2 : 1);
  }
}

// =========== UNDEATH REVIVE ===========
function triggerUndeathRevive(p) {
  if (state.gameOver) return;
  const roll = Math.random() * 100;
  let hpGain, label;
  if (roll < 60) {
    hpGain = Math.floor(state.maxHp[p] * 0.10);
    label = 'BANGKIT 10%!';
  } else if (roll < 90) {
    hpGain = Math.floor(state.maxHp[p] * 0.20);
    label = 'BANGKIT 20%!';
  } else {
    hpGain = state.maxHp[p];
    label = 'BANGKIT 100%!';
  }
  state.hp[p] = Math.min(hpGain, state.maxHp[p]);
  updateHpBar(p);

  // Revive animation on ball
  const ball = document.getElementById(`ball-p${p}`);
  ball.classList.add('undeath-reviving');
  setTimeout(() => ball.classList.remove('undeath-reviving'), 1800);

  // Revive text popup
  const arena = document.getElementById('arena');
  const txt = document.createElement('div');
  txt.className = 'undeath-revive-text';
  txt.textContent = 'üíÄ ' + label;
  txt.style.left = (state.pos[p].x + BALL_SIZE/2) + 'px';
  txt.style.top  = (state.pos[p].y + BALL_SIZE/2) + 'px';
  arena.appendChild(txt);
  setTimeout(() => txt.remove(), 1400);

  document.getElementById(`skill-label-p${p}`).textContent = 'üíÄ REVIVE: SUDAH DIPAKAI';
  document.getElementById(`cd-p${p}`).style.width = '0%';
  addLog(`üíÄ UNDEATH P${p} BANGKIT! HP +${hpGain} (${label})`, 'special');
}

function updateHpBar(p) {
  const pct = (state.hp[p] / state.maxHp[p]) * 100;
  document.getElementById(`hp-bar-p${p}`).style.width = Math.max(0, pct) + '%';
  document.getElementById(`hp-text-p${p}`).textContent = `${Math.max(0, state.hp[p])} HP`;
}

function showDamagePopup(target, dmg) {
  const arena = document.getElementById('arena');
  const el = document.createElement('div');
  el.className = 'dmg-popup';
  el.textContent = `-${dmg}`;
  el.style.color = target === 1 ? 'var(--p1)' : 'var(--p2)';
  el.style.left = (state.pos[target].x + BALL_SIZE/2) + 'px';
  el.style.top  = (state.pos[target].y) + 'px';
  arena.appendChild(el);
  setTimeout(() => el.remove(), 900);
}

function showMiss(target) {
  const arena = document.getElementById('arena');
  const el = document.createElement('div');
  el.className = 'dmg-miss';
  el.textContent = 'DODGE!';
  el.style.left = (state.pos[target].x + BALL_SIZE/2) + 'px';
  el.style.top  = (state.pos[target].y) + 'px';
  arena.appendChild(el);
  setTimeout(() => el.remove(), 900);
}

// =========== LOG ===========
function addLog(msg, cls = '') {
  const inner = document.getElementById('log-inner');
  const el = document.createElement('div');
  el.className = `log-entry ${cls}`;
  el.textContent = msg;
  inner.insertBefore(el, inner.firstChild);
  while (inner.children.length > 8) inner.removeChild(inner.lastChild);
}


// =========== POHON SKILL TIMER ===========
function startPohonTimer(p) {
  if (state.gameOver || state.chars[p] !== 'pohon') return;
  tickPohon(p, 5);
}

function tickPohon(p, remaining) {
  if (state.gameOver || state.chars[p] !== 'pohon') return;
  // POHON is immune to stun, so no stunned check here!
  if (remaining <= 0) {
    spawnPohonTree(p);
    state.pohonSkillInterval[p] = setTimeout(() => tickPohon(p, 5), 500);
    return;
  }
  const pct = ((5 - remaining) / 5) * 100;
  document.getElementById(`cd-p${p}`).style.width = pct + '%';
  document.getElementById(`skill-label-p${p}`).textContent = `üå¥ Pohon: ${remaining}s`;
  state.pohonSkillInterval[p] = setTimeout(() => tickPohon(p, remaining - 1), 1000);
}

function spawnPohonTree(p) {
  if (state.gameOver) return;
  const arena = document.getElementById('arena');
  const el = document.createElement('div');
  el.className = 'pohon-tree';
  el.textContent = 'üå¥';

  // Start at player center
  const startX = state.pos[p].x + BALL_SIZE / 2;
  const startY = state.pos[p].y + BALL_SIZE / 2;

  // Aim toward opponent current position
  const opp = p === 1 ? 2 : 1;
  const targetX = state.pos[opp].x + BALL_SIZE / 2;
  const targetY = state.pos[opp].y + BALL_SIZE / 2;
  const dx = targetX - startX;
  const dy = targetY - startY;
  const dist = Math.sqrt(dx*dx + dy*dy) || 1;
  const speed = 7;
  const vx = (dx / dist) * speed;
  const vy = (dy / dist) * speed;

  el.style.left = startX + 'px';
  el.style.top  = startY + 'px';
  arena.appendChild(el);

  addLog(`üå¥ POHON P${p} lempar pohon ke P${opp}!`, `p${p}`);
  document.getElementById(`skill-label-p${p}`).textContent = `üå¥ POHON TERBANG!`;
  document.getElementById(`cd-p${p}`).style.width = '100%';

  const treeData = { x: startX, y: startY, vx, vy, owner: p, el, timeout: null, hit: false };
  state.pohonTrees.push(treeData);

  // Auto-remove after 3 seconds if no hit
  treeData.timeout = setTimeout(() => {
    if (el.parentNode) el.parentNode.removeChild(el);
    const idx = state.pohonTrees.indexOf(treeData);
    if (idx !== -1) state.pohonTrees.splice(idx, 1);
  }, 3000);
}

function checkPohonTrees() {
  if (state.pohonTrees.length === 0) return;

  for (let i = state.pohonTrees.length - 1; i >= 0; i--) {
    const tree = state.pohonTrees[i];
    if (!tree.el || !tree.el.parentNode || tree.hit) continue;

    // Move tree
    tree.x += tree.vx;
    tree.y += tree.vy;
    tree.el.style.left = tree.x + 'px';
    tree.el.style.top  = tree.y + 'px';

    // Check collision with opponent only (not self)
    const target = tree.owner === 1 ? 2 : 1;
    const bx = state.pos[target].x + BALL_SIZE / 2;
    const by = state.pos[target].y + BALL_SIZE / 2;
    const dist = Math.sqrt((bx - tree.x) ** 2 + (by - tree.y) ** 2);

    if (dist < BALL_SIZE * 0.85) {
      tree.hit = true;
      clearTimeout(tree.timeout);
      // Hit animation then remove
      tree.el.style.animation = 'treeHit 0.3s ease-out forwards';
      setTimeout(() => {
        if (tree.el.parentNode) tree.el.parentNode.removeChild(tree.el);
      }, 300);
      state.pohonTrees.splice(i, 1);
      // Deal 5 damage
      const dmg = 5;
      addLog(`üå¥ Pohon kena P${target}! -${dmg} HP!`, 'special');
      dealDamage(target, dmg);
    }
  }
}

// =========== JHON SKILL TIMER ===========
function startJhonTimer(p) {
  if (state.gameOver || state.chars[p] !== 'jhon') return;
  tickJhon(p, 10);
}

function tickJhon(p, remaining) {
  if (state.gameOver || state.chars[p] !== 'jhon') return;
  if (state.stunned[p]) {
    state.jhonSkillInterval[p] = setTimeout(() => tickJhon(p, remaining), 200);
    return;
  }
  if (remaining <= 0) {
    activateJhonSkill(p);
    return;
  }
  const pct = ((10 - remaining) / 10) * 100;
  document.getElementById('cd-p' + p).style.width = pct + '%';
  document.getElementById('skill-label-p' + p).textContent = 'üí° Flash: ' + remaining + 's';
  state.jhonSkillInterval[p] = setTimeout(() => tickJhon(p, remaining - 1), 1000);
}

function activateJhonSkill(p) {
  if (state.gameOver || state.chars[p] !== 'jhon') return;
  if (tryCounter(p)) {
    addLog('üí° Flash JHON P' + p + ' di-COUNTER! Skill batal!', 'special');
    startJhonTimer(p);
    return;
  }
  const target = p === 1 ? 2 : 1;
  addLog('üí° JHON P' + p + ' tembak cahaya! P' + target + ' BUTA & STUN!', 'special');

  // Flash seluruh arena
  const arena = document.getElementById('arena');
  const flashEl = document.createElement('div');
  flashEl.className = 'jhon-flash';
  arena.appendChild(flashEl);
  setTimeout(() => flashEl.remove(), 500);

  document.getElementById('skill-label-p' + p).textContent = 'üí° FLASH AKTIF!';
  document.getElementById('cd-p' + p).style.width = '100%';

  // Stun target 2 detik (kecuali pohon immune)
  if (state.chars[target] === 'pohon') {
    addLog('üå¥ POHON P' + target + ' IMMUNE! Flash ga mempan!', 'special');
  } else {
    // Stun 2 detik
    state.stunned[target] = true;
    const ball = document.getElementById('ball-p' + target);
    ball.classList.add('stunned');

    const stars = document.createElement('div');
    stars.className = 'stun-stars';
    stars.id = 'stun-stars-' + target;
    stars.textContent = '‚≠êüí°‚≠ê';
    arena.appendChild(stars);

    if (state.stunTimeout[target]) clearTimeout(state.stunTimeout[target]);
    state.stunTimeout[target] = setTimeout(() => {
      if (state.gameOver) return;
      state.stunned[target] = false;
      ball.classList.remove('stunned');
      const s = document.getElementById('stun-stars-' + target);
      if (s) s.remove();
      addLog('P' + target + ' bebas dari stun JHON!', 'p' + target);
      // Lanjutkan skill timer karakter target setelah stun
      const ch = state.chars[target];
      if (ch === 'nuke')  state.nukeInterval[target] = setTimeout(() => tickNuke(target), 200);
      else if (ch === 'doge' && !state.dodge[target]) state.dogeSkillInterval[target] = setTimeout(() => tickDoge(target), 200);
      else if (ch === 'world') state.worldSkillInterval[target] = setTimeout(() => tickWorld(target), 200);
      else if (ch === 'jhon') state.jhonSkillInterval[target] = setTimeout(() => tickJhon(target, 0), 200);
    }, 2000);

    // Slow 5% selama 4 detik
    if (state.jhonSlowTimeout[target]) clearTimeout(state.jhonSlowTimeout[target]);
    state.jhonSlowed[target] = true;

    // Tambah slow ring visual di bola target
    const existRing = document.getElementById('jhon-slow-ring-' + target);
    if (existRing) existRing.remove();
    const ring = document.createElement('div');
    ring.className = 'jhon-slow-ring';
    ring.id = 'jhon-slow-ring-' + target;
    ring.style.width  = (BALL_SIZE + 16) + 'px';
    ring.style.height = (BALL_SIZE + 16) + 'px';
    ring.style.left   = (state.pos[target].x + BALL_SIZE/2) + 'px';
    ring.style.top    = (state.pos[target].y + BALL_SIZE/2) + 'px';
    arena.appendChild(ring);
    addLog('üí° P' + target + ' di-SLOW 5% selama 4 detik!', 'special');

    state.jhonSlowTimeout[target] = setTimeout(() => {
      if (state.gameOver) return;
      state.jhonSlowed[target] = false;
      const r = document.getElementById('jhon-slow-ring-' + target);
      if (r) r.remove();
      addLog('P' + target + ' bebas dari slow JHON!', 'p' + target);
    }, 4000);
  }

  // Restart cooldown
  setTimeout(() => startJhonTimer(p), 500);
}

// =========== SECRET UNLOCK (SAWIT + DEVLO) ===========
let pohonUnlocked = false;
let jhonUnlocked = false;
const SECRET_CODE = 'SAWIT';
const SECRET_CODE_JHON = 'DEVLO';

(function setupSecretInputs() {
  const digits = Array.from({length: 5}, (_, i) => document.getElementById('sd' + i));

  digits.forEach((input, idx) => {
    input.addEventListener('input', (e) => {
      const val = e.target.value.toUpperCase().replace(/[^A-Z]/g, '');
      e.target.value = val.slice(-1);
      if (val) {
        // Auto-advance to next
        if (idx < 4) digits[idx + 1].focus();
        checkSecretCode(digits);
      }
    });

    input.addEventListener('keydown', (e) => {
      if (e.key === 'Backspace' && !input.value && idx > 0) {
        digits[idx - 1].focus();
        digits[idx - 1].value = '';
      }
    });

    // Prevent non-alpha
    input.addEventListener('keypress', (e) => {
      if (!/[a-zA-Z]/.test(e.key)) e.preventDefault();
    });
  });
})();

function checkSecretCode(digits) {
  const entered = digits.map(d => d.value.toUpperCase()).join('');
  if (entered.length < 5) return;

  if (entered === SECRET_CODE) {
    digits.forEach(d => d.classList.add('correct'));
    if (!pohonUnlocked) {
      pohonUnlocked = true;
      setTimeout(unlockPohon, 400);
    }
  } else if (entered === SECRET_CODE_JHON) {
    digits.forEach(d => d.classList.add('correct'));
    if (!jhonUnlocked) {
      jhonUnlocked = true;
      setTimeout(unlockJhon, 400);
    }
  } else if (entered.length === 5) {
    digits.forEach(d => d.classList.add('wrong'));
    setTimeout(() => {
      digits.forEach(d => { d.classList.remove('wrong'); d.value = ''; });
      digits[0].focus();
    }, 600);
  }
}

function unlockJhon() {
  document.getElementById('jhon-card-p1').style.display = '';
  document.getElementById('jhon-card-p2').style.display = '';

  const label = document.querySelector('.secret-label');
  if (label) { label.textContent = 'üí° Kode Benar! JHON Terbuka!'; label.style.color = '#ffe066'; }

  const notif = document.createElement('div');
  notif.className = 'secret-unlock';
  notif.style.color = '#ffe066';
  notif.style.borderColor = '#ffe066';
  notif.style.textShadow = '0 0 40px #ffe066, 0 0 80px #ffcc00';
  notif.innerHTML = 'üí° JHON UNLOCKED! üí°<small>Karakter Rahasia Terbuka!</small>';
  document.body.appendChild(notif);
  setTimeout(() => notif.remove(), 3000);
}

function unlockPohon() {
  // Show both pohon cards
  document.getElementById('pohon-card-p1').style.display = '';
  document.getElementById('pohon-card-p2').style.display = '';

  // Update label
  const label = document.querySelector('.secret-label');
  if (label) { label.textContent = 'üå¥ Kode Benar! POHON Terbuka!'; label.style.color = '#00ff44'; }

  // Show dramatic unlock notification
  const notif = document.createElement('div');
  notif.className = 'secret-unlock';
  notif.innerHTML = 'üå¥ POHON UNLOCKED! üå¥<small>Karakter Rahasia Terbuka!</small>';
  document.body.appendChild(notif);
  setTimeout(() => notif.remove(), 3000);
}

// =========== END GAME ===========
function endGame(winner) {
  state.gameOver = true;
  cancelAnimationFrame(state.rafId);

  [1, 2].forEach(p => {
    clearInterval(state.nukeInterval[p]);
    clearInterval(state.dogeSkillInterval[p]);
    clearInterval(state.worldSkillInterval[p]);
    clearInterval(state.skillCdInterval[p]);
    if (state.stunTimeout[p]) clearTimeout(state.stunTimeout[p]);
    if (state.pohonSkillInterval[p]) clearTimeout(state.pohonSkillInterval[p]);
    if (state.jhonSkillInterval[p]) clearTimeout(state.jhonSkillInterval[p]);
    if (state.jhonSlowTimeout[p]) clearTimeout(state.jhonSlowTimeout[p]);
    state.jhonSlowed[p] = false;
    const slowRing = document.getElementById('jhon-slow-ring-' + p); if (slowRing) slowRing.remove();
    const el = document.getElementById(`nuke-timer-${p}`);
    if (el) el.remove();
    document.getElementById(`ball-p${p}`)?.classList.remove('counter-clash', 'mih-active', 'stunned');
    const stars = document.getElementById(`stun-stars-${p}`);
    if (stars) stars.remove();
  });

  // Clear pohon trees
  state.pohonTrees.forEach(t => { if (t.el && t.el.parentNode) t.el.parentNode.removeChild(t.el); clearTimeout(t.timeout); });
  state.pohonTrees = [];

  const wf = document.getElementById('world-freeze');
  if (wf) wf.remove();
  const wt = document.getElementById('world-text');
  if (wt) wt.remove();

  const winChar = state.chars[winner];
  const wBox = document.getElementById('win-box');
  const winColor = winner === 1 ? '#00e5ff' : '#ff4444';
  wBox.style.borderColor = winColor;
  wBox.style.boxShadow = `0 0 60px ${winColor}33`;

  document.getElementById('win-char').textContent = charData[winChar].icon;
  document.getElementById('win-title').textContent = `PLAYER ${winner}`;
  document.getElementById('win-title').style.color = winColor;
  document.getElementById('win-msg').textContent = `${charData[winChar].name} menang! Player ${winner === 1 ? 2 : 1} kalah!`;
  document.getElementById('win-overlay').classList.add('show');

  for (let i = 0; i < 60; i++) {
    setTimeout(() => spawnConfetti(winColor), i * 40);
  }
}

function spawnConfetti(baseColor) {
  const colors = [baseColor, '#fff', '#ffd700', '#ff88ff', '#88ffff'];
  const el = document.createElement('div');
  el.className = 'confetti-piece';
  el.style.left = Math.random() * 100 + 'vw';
  el.style.background = colors[Math.floor(Math.random() * colors.length)];
  el.style.animationDuration = (1.5 + Math.random() * 2) + 's';
  el.style.animationDelay = Math.random() * 0.5 + 's';
  el.style.borderRadius = Math.random() > 0.5 ? '50%' : '2px';
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 3000);
}

// =========== REPLAY ===========
function replay() {
  [1, 2].forEach(p => {
    clearTimeout(state.nukeInterval[p]);
    clearTimeout(state.dogeSkillInterval[p]);
    clearTimeout(state.worldSkillInterval[p]);
    clearTimeout(state.skillCdInterval[p]);
    if (state.stunTimeout[p]) clearTimeout(state.stunTimeout[p]);
    if (state.worldRestartTimeout[p]) clearTimeout(state.worldRestartTimeout[p]);
    if (state.dogeRestartTimeout[p]) clearTimeout(state.dogeRestartTimeout[p]);
    if (state.mihRestartTimeout[p]) clearTimeout(state.mihRestartTimeout[p]);
    if (state.pohonSkillInterval[p]) clearTimeout(state.pohonSkillInterval[p]);
    if (state.jhonSkillInterval[p]) clearTimeout(state.jhonSkillInterval[p]);
    if (state.jhonSlowTimeout[p]) clearTimeout(state.jhonSlowTimeout[p]);
    state.jhonSlowed[p] = false;
    const slowRing = document.getElementById('jhon-slow-ring-' + p); if (slowRing) slowRing.remove();
  });
  cancelAnimationFrame(state.rafId);

  state.pohonTrees.forEach(t => { if (t.el && t.el.parentNode) t.el.parentNode.removeChild(t.el); clearTimeout(t.timeout); });
  state.pohonTrees = [];
  state.chars = { 1: null, 2: null };
  document.querySelectorAll('.char-card').forEach(c => {
    c.classList.remove('selected-nuke', 'selected-doge', 'selected-world', 'selected-mih', 'selected-counter', 'selected-tank', 'selected-pohon', 'selected-div2', 'selected-undeath', 'selected-jhon');
  });
  document.getElementById('start-btn').disabled = true;
  document.getElementById('select-hint').textContent = 'Pilih karakter untuk kedua player';
  document.getElementById('select-hint').style.color = '';
  document.getElementById('win-overlay').classList.remove('show');
  showPage('select');
}

function showPage(name) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById(`page-${name}`).classList.add('active');
}
</script>
</body>
</html>
